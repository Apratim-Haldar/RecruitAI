--- START OF FILE hr_job_applicants.html ---

{% extends "base.html" %}

{% block title %}Applicants for {{ job_title }} ({{ job_id }}){% endblock %}

{% block content %}

{# --- Job Header Card --- #}
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
     <a href="{{ url_for('hr_list_jobs') }}" class="btn btn-sm btn-outline-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/></svg>
        Back to Jobs
     </a>
     {# Placeholder for future AI Help button #}
     {# <button class="btn btn-sm btn-outline-primary">Get AI Help</button> #}
  </div>
  <div class="card-body">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="card-title mb-1">{{ job_title }}</h2>
            <p class="card-subtitle mb-2 text-muted">
                {{ job_id }}
                {# Add Job Type if available #}
                {# <span class="ms-2">Full-time</span> #}
                 <span class="badge ms-2
                    {% if job_status == 'open' %} bg-success
                    {% elif job_status == 'closed' %} bg-warning text-dark
                    {% elif job_status == 'filled' %} bg-secondary
                    {% else %} bg-light text-dark border {% endif %}">
                    {{ job_status | capitalize if job_status else 'Unknown' }}
                 </span>
            </p>
            <div class="d-flex flex-wrap gap-3 text-muted small">
                <span>Posted On: {{ job_date_added if job_date_added != 'N/A' else 'N/A' }}</span>
                {# Add Closing Date if available #}
                {# <span>Closing Date: {{ job_closing_date }}</span> #}
            </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            {# --- Action Buttons --- #}
            {% if job_status in ['closed', 'filled'] %}
                <form action="{{ url_for('reopen_job', job_id=job_id) }}" method="post" class="d-inline-block mb-1" onsubmit="return confirm('Are you sure you want to re-open this job listing? Applicants will be able to apply again.');">
                    <button type="submit" class="btn btn-outline-success btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise me-1" viewBox="0 0 16 16"><use xlink:href="#arrow-clockwise-icon"/></svg>
                        Re-open Job
                    </button>
                </form>
            {% endif %}
             <form action="{{ url_for('finalize_job', job_id=job_id) }}" method="post" onsubmit="return confirm('FINAL ACTION:\n\nAre you sure you want to finalize selections for this job?\n\n- Status of shortlisted candidates will be set to \'Selected\'.\n- Emails (if configured) will be sent to them.\n- The Job status will be set to \'Closed\'.\n\nThis action cannot be easily undone.');" class="d-inline-block mb-1">
                <button type="submit" class="btn btn-success btn-sm" {% if job_status != 'open' %}disabled title="Job is not open"{% endif %}>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill me-1" viewBox="0 0 16 16"><use xlink:href="#check-circle-fill-icon"/></svg>
                    Finalize Selections
                </button>
            </form>
        </div>
    </div>{# End Row #}

    <hr class="my-3">

    {# --- Hiring Progress --- #}
    <div>
        <h6 class="mb-1">Hiring Progress ({{ progress.rated_percent }}% Rated)</h6>
        <div class="progress" role="progressbar" aria-label="Hiring progress" aria-valuenow="{{ progress.rated_percent }}" aria-valuemin="0" aria-valuemax="100" style="height: 10px;">
          <div class="progress-bar bg-info" style="width: {{ progress.rated_percent }}%"></div>
        </div>
        <div class="d-flex justify-content-between flex-wrap mt-1 small text-muted">
            <span>Total Applicants: {{ progress.total }}</span>
            <span>Shortlisted: {{ progress.shortlisted_count }}</span>
            <span>Rated: {{ progress.rated_count }}</span>
            {# Add Interviews / Offers / Pending if needed #}
            <span>Pending Review: {{ progress.pending_count }}</span>
        </div>
    </div>
  </div> {# End card-body #}
</div> {# End Job Header Card #}


{# --- Filter & View Options Card --- #}
<div class="card mb-4">
 <div class="card-body">
    <div class="row g-3 align-items-center">
         {# Filter & Rank Form #}
         <div class="col-md-6">
             <h6 class="mb-2">Filter & Rank Top Applicants</h6>
             <form action="{{ url_for('hr_filter_relevant_applicants', job_id=job_id) }}" method="post" class="d-flex align-items-center flex-wrap gap-2">
                 <label for="top_m" class="col-form-label col-form-label-sm">Show Top</label>
                 <input type="number" id="top_m" name="top_m" class="form-control form-control-sm" value="5" min="1" style="width: 70px;">
                 <label for="top_m" class="col-form-label col-form-label-sm">most relevant:</label>
                 <button type="submit" class="btn btn-primary btn-sm" {% if job_status != 'open' %}disabled title="Job is not open"{% endif %}>
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel-fill me-1" viewBox="0 0 16 16"><use xlink:href="#funnel-fill-icon"/></svg>
                     Filter Now
                 </button>
             </form>
             <div class="form-text small mt-1">Rates unrated candidates first.</div>
         </div>

         {# View Toggles & Job Details #}
         <div class="col-md-6 text-md-end">
              <h6 class="mb-2 d-none d-md-block">Â </h6> {# Spacer for alignment #}
              {# Ranked View Link #}
              <a href="{{ url_for('hr_view_ranked_applicants', job_id=job_id) }}" class="btn btn-warning btn-sm me-2 mb-1">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trophy-fill me-1" viewBox="0 0 16 16"><use xlink:href="#trophy-fill-icon"/></svg>
                 Top Rated
              </a>
               {# Toggle Rejected Visibility #}
               {% if show_rejected %}
                   <a href="{{ url_for('hr_view_applicants', job_id=job_id) }}" class="btn btn-outline-secondary btn-sm me-2 mb-1">Hide Rejected</a>
               {% else %}
                   <a href="{{ url_for('hr_view_applicants', job_id=job_id, show_rejected='true') }}" class="btn btn-outline-secondary btn-sm me-2 mb-1">Show Rejected</a>
               {% endif %}
               {# Job Details Toggle Button #}
               <button class="btn btn-outline-info btn-sm mb-1" type="button" data-bs-toggle="collapse" data-bs-target="#jobDetailsCollapse" aria-expanded="false" aria-controls="jobDetailsCollapse">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle me-1" viewBox="0 0 16 16"><use xlink:href="#info-circle-icon"/></svg>
                  Job Details
               </button>
         </div>
    </div> {# End Row #}
 </div> {# End card-body #}
</div> {# End Filter/View Card #}

{# --- Collapsible Job Details --- #}
<div class="collapse mb-4" id="jobDetailsCollapse">
  <div class="card card-body">
    <h5>Job Description</h5>
    <p style="white-space: pre-wrap;">{{ job_description if job_description else 'No description provided.' }}</p>
    {% if structured_jd %}
      <hr>
      <h5>Key Details (AI Structured)</h5>
      <ul class="list-unstyled small">
          <li><strong>Required Skills:</strong> {{ structured_jd.required_skills | join(', ') if structured_jd.required_skills else 'N/A' }}</li>
          <li><strong>Preferred Skills:</strong> {{ structured_jd.preferred_skills | join(', ') if structured_jd.preferred_skills else 'N/A' }}</li>
          <li><strong>Experience Required:</strong> {{ structured_jd.required_experience_years }} {{ 'years' if structured_jd.required_experience_years else 'N/A' }}</li>
          <li><strong>Education Required:</strong> {{ structured_jd.required_education if structured_jd.required_education else 'N/A' }}</li>
          <li><strong>Responsibilities:</strong>
            {% if structured_jd.key_responsibilities %}
              <ul>{% for item in structured_jd.key_responsibilities %}<li>{{ item }}</li>{% endfor %}</ul>
            {% else %} N/A {% endif %}
          </li>
      </ul>
    {% endif %}
  </div>
</div>


{# --- Applicant Table Card --- #}
<div class="card shadow-sm">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
     <h5 class="mb-0">
        Applicants <span class="badge bg-secondary ms-1">{{ progress.total }}</span>
        {% if not show_rejected %}<small class="text-muted fs-6 fw-normal"> (Rejected Hidden)</small>{% endif %}
     </h5>
     {# TODO: Add Search/Filter controls here later #}
  </div>
  <div class="card-body p-0"> {# Remove padding for full-width table #}
    {% if applicants %}
      <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0"> {# Remove margin bottom #}
            <thead class="table-light">
              <tr>
                {# Removed '#' column for space #}
                <th scope="col">Candidate</th>
                {# Removed Applicant ID column, show in modal #}
                <th scope="col">Applied</th>
                <th scope="col">Status</th>
                <th scope="col">AI Rating</th>
                <th scope="col" class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody class="table-group-divider">
              {% for applicant in applicants %}
              <tr id="applicant-row-{{ loop.index }}" class="applicant-row
                  {% if applicant.status == 'rejected' %} table-secondary text-muted opacity-75 {% endif %}
                  {% if applicant.status == 'shortlisted' %} table-warning {% endif %}
                  {% if applicant.status == 'selected' or applicant.status == 'hired' %} table-success {% endif %}
              ">
                <td>
                    <div class="fw-bold">{{ applicant.name if applicant.name else 'N/A' }}</div>
                    <div class="small text-muted">{{ applicant.applicant_id }}</div>
                </td>
                <td>{{ applicant.application_date_formatted }}</td>
                <td>
                    <span class="badge status-badge {% if applicant.status == 'pending' %} text-bg-light border {% elif applicant.status == 'shortlisted' %} text-bg-warning {% elif applicant.status == 'rejected' %} text-bg-secondary {% elif applicant.status == 'selected' %} text-bg-success {% elif applicant.status == 'hired' %} text-bg-primary {% else %} text-bg-secondary {% endif %}">
                        {{ applicant.status | capitalize if applicant.status else 'Pending' }}
                    </span>
                </td>
                <td> {# AI Rating Display #}
                  {% set star_rating = applicant.rating | to_5_star %}
                  {% if star_rating is not none %}
                     <span class="badge text-bg-primary fs-6" data-bs-toggle="tooltip" data-bs-title="Original Score: {{ applicant.rating }}/100">
                         <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-star-fill me-1" viewBox="0 0 16 16" style="margin-bottom: 2px;"><use xlink:href="#star-fill-icon"/></svg>
                         {{ star_rating }}
                     </span>
                  {% elif job_status == 'open' %} {# Only show rate button if job is open #}
                     <form action="{{ url_for('hr_rate_applicant', applicant_id=applicant.applicant_id, job_id=job_id, show_rejected=request.args.get('show_rejected', 'false')) }}" method="post" style="display: inline;">
                         <button type="submit" class="btn btn-sm btn-info py-0 px-1" data-bs-toggle="tooltip" data-bs-title="Run AI Rating">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16"><use xlink:href="#stars-icon"/></svg> Rate
                         </button>
                      </form>
                  {% else %}
                     <span class="badge text-bg-secondary" data-bs-toggle="tooltip" data-bs-title="Needs Rating">
                         Not Rated
                     </span>
                  {% endif %}
                </td>
                <td class="text-center"> {# Actions #}
                    {# View Details Modal Trigger #}
                     <button class="btn btn-sm btn-outline-primary me-1 view-details-btn"
                             data-bs-toggle="modal" data-bs-target="#applicantDetailModal"
                             data-applicant-id="{{ applicant.applicant_id }}"
                             data-job-id="{{ job_id }}"
                             {# Pass minimal data needed before AJAX #}
                             data-applicant-name="{{ applicant.name if applicant.name else 'N/A' }}"
                             data-applicant-email="{{ applicant.applicant_id }}"
                             data-resume-path="{{ applicant.resume_file_path }}"
                             data-bs-toggle-tooltip="tooltip" data-bs-title="View Details">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-lines-fill" viewBox="0 0 16 16"><use xlink:href="#person-lines-fill-icon"/></svg>
                     </button>

                    {# Shortlist Button #}
                    <button class="btn btn-sm status-btn {% if applicant.status == 'shortlisted' %}btn-warning{% else %}btn-outline-warning{% endif %}"
                            data-applicant-id="{{ applicant.applicant_id }}" data-job-id="{{ job_id }}" data-status="shortlisted"
                            data-bs-toggle="tooltip" title="Shortlist" {% if job_status != 'open' %}disabled{% endif %}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star-fill" viewBox="0 0 16 16"><use xlink:href="#star-fill-icon"/></svg>
                    </button>
                     {# Reject Button #}
                    <button class="btn btn-sm status-btn {% if applicant.status == 'rejected' %}btn-secondary{% else %}btn-outline-secondary{% endif %}"
                            data-applicant-id="{{ applicant.applicant_id }}" data-job-id="{{ job_id }}" data-status="rejected"
                            data-bs-toggle="tooltip" title="Reject" {% if job_status != 'open' %}disabled{% endif %}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16"><use xlink:href="#x-lg-icon"/></svg>
                    </button>
                    {# Reset to Pending Button #}
                    {% if applicant.status != 'pending' %}
                    <button class="btn btn-sm status-btn btn-outline-info ms-1"
                            data-applicant-id="{{ applicant.applicant_id }}" data-job-id="{{ job_id }}" data-status="pending"
                            data-bs-toggle="tooltip" title="Reset Status" {% if job_status != 'open' %}disabled{% endif %}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16"><use xlink:href="#arrow-clockwise-icon"/></svg>
                    </button>
                    {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
      </div> {# End table-responsive #}
    {% else %}
      <div class="alert alert-warning m-3" role="alert">
        No applicants found matching the current criteria (Job: {{ job_id }}{% if not show_rejected %}, Status: Pending/Shortlisted{% endif %}).
      </div>
    {% endif %}
  </div>{# End card-body #}
   <div class="card-footer bg-light text-end">
      <button class="btn btn-sm btn-outline-info rate-all-unrated-btn"
              data-job-id="{{ job_id }}"
              data-bs-toggle="tooltip"
              data-bs-title="Rate All Unrated Applicants"
              {% if job_status != 'open' %}disabled{% endif %}>
           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars me-1" viewBox="0 0 16 16"><use xlink:href="#stars-icon"/></svg>
           Rate All Unrated
      </button>
   </div>
</div> {# End Applicant Table Card #}


{# --- Applicant Detail Modal --- #}
<div class="modal fade" id="applicantDetailModal" tabindex="-1" aria-labelledby="applicantDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        {# Modal Header Content (populated by JS) #}
        <div class="d-flex align-items-center">
             <span class="badge bg-primary-subtle text-primary-emphasis rounded-circle p-2 me-2 fs-5" id="modalApplicantInitials">XX</span>
             <div>
                <h5 class="modal-title mb-0" id="applicantDetailModalLabel">Applicant Name</h5>
                <small class="text-muted" id="modalExperience" style="display: none;"></small> {# Hide initially #}
             </div>
        </div>
        <span class="badge text-bg-info ms-auto me-2" id="modalMatchPercent" style="display: none;">N/A Match</span> {# Hide initially #}
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          {# Spinner for AJAX loading #}
          <div id="modalDetailSpinner" class="text-center my-5">
             <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
             <p class="mt-2">Loading details...</p>
          </div>

          {# Content Area (hidden initially) #}
          <div id="modalDetailContent" style="display: none;">
              {# Tabs: Profile / Resume #}
              <ul class="nav nav-tabs nav-fill mb-3" id="applicantTab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="true">Profile</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="resume-tab" data-bs-toggle="tab" data-bs-target="#resume-tab-pane" type="button" role="tab" aria-controls="resume-tab-pane" aria-selected="false">Resume</button>
                </li>
              </ul>
              <div class="tab-content" id="applicantTabContent">
                {# Profile Tab Pane #}
                <div class="tab-pane fade show active" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
                    <div class="row g-3">
                        {# Left Column #}
                        <div class="col-md-7">
                            <div class="mb-3">
                                <h6>Contact Information</h6>
                                <ul class="list-unstyled small text-muted">
                                    {# Email LI #}
                                    <li id="modal-li-email"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope me-2" viewBox="0 0 16 16"><use xlink:href="#envelope-icon"/></svg><span id="modalApplicantEmail"></span></li>
                                    {# Phone LI - Hide initially #}
                                    <li id="modal-li-phone" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-telephone me-2" viewBox="0 0 16 16"><use xlink:href="#telephone-icon"/></svg><span id="modalApplicantPhone"></span></li>
                                    {# Applied Date LI #}
                                    <li id="modal-li-applied"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar3 me-2" viewBox="0 0 16 16"><use xlink:href="#calendar-icon"/></svg>Applied on <span id="modalAppliedDate"></span></li>
                                    {# Add Location if available #}
                                </ul>
                            </div>
                            <div class="mb-3">
                                <h6>Overall AI Analysis</h6>
                                <p class="small" id="modalAiSummary"></p>
                            </div>
                             <div class="mb-3">
                                <h6>AI Evaluation Score</h6>
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold me-2" id="modalRatingScore">N/A</span>
                                    <div class="progress flex-grow-1" role="progressbar" aria-label="AI Score" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 8px;">
                                      <div class="progress-bar" id="modalRatingBar" style="width: 0%"></div>
                                    </div>
                                </div>
                             </div>
                        </div>
                        {# Right Column #}
                        <div class="col-md-5">
                            <h6>Application Details</h6>
                            <ul class="list-group list-group-flush small">
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0" id="modal-li-status">Status: <span class="badge" id="modalApplicantStatus"></span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0" id="modal-li-exp-right" style="display: none;">Experience: <span id="modalExperienceRight"></span></li>
                                {# Add other details like Immediate Joiner, Offer Letter if tracked #}
                                <li class="list-group-item px-0" id="modal-li-skills" style="display: none;">
                                    Skills: <span id="modalSkillsList" class="text-muted"></span>
                                </li>
                                 <li class="list-group-item px-0" id="modal-li-education" style="display: none;">
                                    Education: <span id="modalEducationList" class="text-muted"></span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                {# Resume Tab Pane #}
                <div class="tab-pane fade" id="resume-tab-pane" role="tabpanel" aria-labelledby="resume-tab" tabindex="0">
                    <p class="text-center">
                        <a href="#" id="modalViewResumeLink" target="_blank" class="btn btn-primary">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-text me-1" viewBox="0 0 16 16"><use xlink:href="#file-earmark-text-icon"/></svg>
                           View Uploaded Resume
                        </a>
                    </p>
                    <p class="text-center text-muted small" id="modalResumeError" style="display: none;">Resume file not found or link unavailable.</p>
                </div>
              </div>
          </div> {# End modalDetailContent #}
      </div> {# End modal-body #}
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{# --- SVG Icon Definitions (Add more as needed) --- #}
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="stars-icon" viewBox="0 0 16 16"><path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774.258c.346-.115.617-.386.732-.732z"/></symbol>
    <symbol id="star-fill-icon" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></symbol>
    <symbol id="arrow-clockwise-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192L10.77 2.308a.25.25 0 0 1 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></symbol>
    <symbol id="check-circle-fill-icon" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></symbol>
    <symbol id="funnel-fill-icon" viewBox="0 0 16 16"><path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5z"/></symbol>
    <symbol id="trophy-fill-icon" viewBox="0 0 16 16"><path d="M2.5.5A.5.5 0 0 1 3 .5h10a.5.5 0 0 1 .5.5c0 .538-.012 1.05-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 0 1-.3.9H3a.5.5 0 0 1-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33 33 0 0 1 2.5 1 .5.5 0 0 1 2.5.5m.099 2.54a2 2 0 0 0 .72 3.935c-.333-1.05-.588-2.346-.72-3.935zm10.083 3.935a2 2 0 0 0 .72-3.935c-.133 1.59-.388 2.886-.72 3.935"/></symbol>
    <symbol id="info-circle-icon" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></symbol>
    <symbol id="person-lines-fill-icon" viewBox="0 0 16 16"><path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1zm0 3a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1zm0 3a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1z"/></symbol>
    <symbol id="x-lg-icon" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></symbol>
    <symbol id="envelope-icon" viewBox="0 0 16 16"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z"/></symbol>
    <symbol id="telephone-icon" viewBox="0 0 16 16"><path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.612l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z"/></symbol>
    <symbol id="calendar-icon" viewBox="0 0 16 16"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/></symbol>
    <symbol id="file-earmark-text-icon" viewBox="0 0 16 16"><path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5"/><path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/></symbol>
</svg>


{# --- JavaScript --- #}
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        console.log("Applicant List DOM loaded.");

        // Initialize tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        // --- Applicant Detail Modal Logic ---
        const detailModalElement = document.getElementById('applicantDetailModal');
        if (detailModalElement) {
            const detailModalInstance = new bootstrap.Modal(detailModalElement);
            const modalSpinner = document.getElementById('modalDetailSpinner');
            const modalContent = document.getElementById('modalDetailContent');
            const modalTitle = document.getElementById('applicantDetailModalLabel');
            const modalInitials = document.getElementById('modalApplicantInitials');
            const modalExperience = document.getElementById('modalExperience'); // Top experience text
            const modalMatch = document.getElementById('modalMatchPercent'); // Assuming match % comes later

            // --- Contact Info Elements ---
            const modalEmail = document.getElementById('modalApplicantEmail');
            const modalPhone = document.getElementById('modalApplicantPhone');
            const phoneLi = document.getElementById('modal-li-phone'); // Get the LI for phone
            const modalAppliedDate = document.getElementById('modalAppliedDate');

            // --- AI Analysis Elements ---
            const modalSummary = document.getElementById('modalAiSummary');
            const modalRatingScore = document.getElementById('modalRatingScore');
            const modalRatingBar = document.getElementById('modalRatingBar');

            // --- Right Column Application Details ---
            const modalStatus = document.getElementById('modalApplicantStatus');
            const modalExperienceRight = document.getElementById('modalExperienceRight');
            const expRightLi = document.getElementById('modal-li-exp-right'); // Get the LI for experience (right)
            const modalSkills = document.getElementById('modalSkillsList');
            const skillsLi = document.getElementById('modal-li-skills');     // Get the LI for skills
            const modalEducation = document.getElementById('modalEducationList');
            const eduLi = document.getElementById('modal-li-education');   // Get the LI for education

            // --- Resume Tab Elements ---
            const modalResumeLink = document.getElementById('modalViewResumeLink');
            const modalResumeError = document.getElementById('modalResumeError');

            detailModalElement.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget; // Button that triggered the modal
                const applicantId = button.dataset.applicantId;
                const jobId = button.dataset.jobId;
                const applicantName = button.dataset.applicantName;
                const resumePath = button.dataset.resumePath; // Get resume path

                // --- Reset Modal Content & Show Spinner ---
                modalTitle.textContent = applicantName || 'Loading...'; // Show name immediately
                modalInitials.textContent = applicantName ? applicantName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0,2) : '??';
                modalExperience.textContent = ''; // Clear text
                modalExperience.style.display = 'none'; // *** HIDE by default ***
                modalMatch.style.display = 'none'; // Hide match for now
                modalSpinner.style.display = 'block';
                modalContent.style.display = 'none';

                // Reset Contact Info
                modalEmail.textContent = 'Loading...';
                modalPhone.textContent = ''; // Clear text
                phoneLi.style.display = 'none'; // *** HIDE by default ***
                modalAppliedDate.textContent = 'Loading...';

                // Reset AI Analysis
                modalSummary.textContent = 'Loading...';
                modalRatingScore.textContent = 'N/A';
                modalRatingBar.style.width = '0%';
                modalRatingBar.className = 'progress-bar'; // Reset colors

                // Reset Right Column Details
                modalStatus.textContent = 'Loading...';
                modalStatus.className = 'badge'; // Reset badge class
                modalExperienceRight.textContent = ''; // Clear text
                expRightLi.style.display = 'none'; // *** HIDE by default ***
                modalSkills.textContent = ''; // Clear text
                skillsLi.style.display = 'none'; // *** HIDE by default ***
                modalEducation.textContent = ''; // Clear text
                eduLi.style.display = 'none'; // *** HIDE by default ***

                // Reset Resume Tab
                modalResumeLink.href = '#';
                modalResumeLink.style.display = 'none'; // Hide link initially
                modalResumeError.style.display = 'none'; // Hide error

                // --- Fetch Full Details via AJAX ---
                const fetchUrl = `/hr/details/${encodeURIComponent(applicantId)}/${encodeURIComponent(jobId)}`;
                console.log(`Fetching modal details from: ${fetchUrl}`);

                fetch(fetchUrl)
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => { throw new Error(errData.error || `HTTP error ${response.status}`); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Modal details received:", data);

                        // --- Populate Modal with Fetched Data (with checks) ---
                        modalEmail.textContent = data.email || 'N/A'; // Email is usually present
                        modalAppliedDate.textContent = data.application_date || 'N/A';

                        // --- Phone Number (Conditional Display) ---
                        if (data.phone) {
                            modalPhone.textContent = data.phone;
                            phoneLi.style.display = ''; // Show LI
                        } else {
                            phoneLi.style.display = 'none'; // Keep hidden
                        }

                        // --- AI Summary ---
                        modalSummary.textContent = data.ai_summary || 'No AI summary available.';

                        // --- Rating ---
                        const rating = data.rating;
                        if (rating !== null && rating !== undefined) {
                            const ratingInt = parseInt(rating);
                            modalRatingScore.textContent = `${ratingInt}/100`;
                            modalRatingBar.style.width = `${ratingInt}%`;
                            if (ratingInt >= 75) modalRatingBar.classList.add('bg-success');
                            else if (ratingInt >= 50) modalRatingBar.classList.add('bg-warning');
                            else if (ratingInt > 0) modalRatingBar.classList.add('bg-danger');
                            else modalRatingBar.classList.add('bg-secondary');
                        } else {
                            modalRatingScore.textContent = 'Not Rated';
                            modalRatingBar.style.width = '0%';
                             modalRatingBar.classList.add('bg-secondary');
                        }

                        // --- Status ---
                        const status = data.status ? data.status.toLowerCase() : 'pending';
                        modalStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                        modalStatus.className = 'badge'; // Reset
                        if (status === 'pending') modalStatus.classList.add('text-bg-light', 'border');
                        else if (status === 'shortlisted') modalStatus.classList.add('text-bg-warning');
                        else if (status === 'rejected') modalStatus.classList.add('text-bg-secondary');
                        else if (status === 'selected') modalStatus.classList.add('text-bg-success');
                        else if (status === 'hired') modalStatus.classList.add('text-bg-primary');
                        else modalStatus.classList.add('text-bg-secondary');


                        // --- Experience (Conditional Display) ---
                        const expYears = data.experience_years;
                        if (expYears !== null && expYears !== undefined) { // Check for null or undefined specifically
                            const expText = `${expYears} year${expYears !== 1 ? 's' : ''}`;
                            // Top Experience
                            modalExperience.textContent = expText + ' experience';
                            modalExperience.style.display = ''; // Show
                            // Right Column Experience
                            modalExperienceRight.textContent = expText;
                            expRightLi.style.display = ''; // Show LI
                        } else {
                            modalExperience.style.display = 'none'; // Keep hidden
                            expRightLi.style.display = 'none';   // Keep hidden
                        }

                        // --- Skills (Conditional Display) ---
                        if (data.skills && data.skills.length > 0) {
                            modalSkills.textContent = data.skills.join(', ');
                            skillsLi.style.display = ''; // Show LI
                        } else {
                            skillsLi.style.display = 'none'; // Keep hidden
                        }

                        // --- Education (Conditional Display) ---
                        if (data.education && data.education.length > 0) {
                            const eduText = data.education.map(edu => `${edu.degree || '?'} at ${edu.institution || '?'}${edu.year ? ` (${edu.year})` : ''}`).join('; ');
                            modalEducation.textContent = eduText;
                            eduLi.style.display = ''; // Show LI
                        } else {
                            eduLi.style.display = 'none'; // Keep hidden
                        }

                        // Resume Link
                        if (data.resume_file_path) {
                            modalResumeLink.href = `{{ url_for('view_resume', filename='') }}${encodeURIComponent(data.resume_file_path)}`;
                            modalResumeLink.style.display = 'inline-block';
                            modalResumeError.style.display = 'none';
                        } else {
                            modalResumeLink.style.display = 'none';
                            modalResumeError.style.display = 'block';
                        }

                        // --- Hide Spinner, Show Content ---
                        modalSpinner.style.display = 'none';
                        modalContent.style.display = 'block';

                        // Ensure the Profile tab is active by default
                        const profileTab = document.getElementById('profile-tab');
                        if (profileTab) bootstrap.Tab.getOrCreateInstance(profileTab).show();


                    })
                    .catch(error => {
                        console.error('Error fetching modal details:', error);
                        modalSpinner.innerHTML = `<p class="text-danger">Error loading details: ${error.message}</p>`;
                        modalContent.style.display = 'none'; // Keep content hidden
                        modalSpinner.style.display = 'block'; // Keep spinner area visible for error message
                    });
            });
        } // end if detailModalElement

        // --- Status Update Logic ---
        const statusUpdateUrlTemplate = "{{ url_for('update_status', applicant_id='APPLICANT_ID_PLACEHOLDER', job_id='JOB_ID_PLACEHOLDER') }}";

        // --- Rate All Unrated Logic ---
        const rateAllButton = document.querySelector('.rate-all-unrated-btn');
        if (rateAllButton) {
             rateAllButton.addEventListener('click', function(e) {
                e.preventDefault();
                const button = this;
                const jobId = button.dataset.jobId;
                const originalHtml = button.innerHTML;
                // Use custom confirm if available, fallback to browser confirm
                const confirmAction = () => {
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Rating...';
                    const rateAllUrl = `/hr/rate_all_unrated/${encodeURIComponent(jobId)}`;
                    fetch(rateAllUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', {# CSRF if needed #} }
                    })
                    .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err)) )
                    .then(data => { showCustomAlert(data.message || 'Rating process completed.', 'Rating Status'); window.location.reload(); })
                    .catch(error => { showCustomAlert(`Error triggering rating: ${error.error || error.message || 'Unknown error'}`, 'Error'); })
                    .finally(() => { button.disabled = false; button.innerHTML = originalHtml; });
                };
                const message = `This will trigger AI rating for ALL applicants in the job '${jobId}' who haven't been rated yet. This might take some time and consume resources. Continue?`;
                if (window.showCustomConfirm) {
                     showCustomConfirm(message, confirmAction, 'Confirm Batch Rating');
                 } else {
                     if (confirm(message)) { confirmAction(); }
                 }
            });
        }

        // --- Event Delegation for Table Actions (Status buttons) ---
        const tableBody = document.querySelector('tbody.table-group-divider');
        if (tableBody) {
            tableBody.addEventListener('click', function(e) {
                const targetButton = e.target.closest('button.status-btn'); // Target only status buttons here
                if (!targetButton) return;

                e.preventDefault();
                const button = targetButton;
                const applicantId = button.dataset.applicantId;
                const jobId = button.dataset.jobId;
                const newStatus = button.dataset.status;
                const originalButtonHtml = button.innerHTML;
                button.disabled = true; button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                const fetchUrl = statusUpdateUrlTemplate.replace('APPLICANT_ID_PLACEHOLDER', encodeURIComponent(applicantId)).replace('JOB_ID_PLACEHOLDER', encodeURIComponent(jobId));

                fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', {# CSRF if needed #} },
                    body: JSON.stringify({ status: newStatus })
                })
                .then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err)) )
                .then(data => {
                    if (data.success) {
                        const applicantRow = button.closest('tr.applicant-row');
                        if (applicantRow) {
                             // Update Row Style
                             applicantRow.classList.remove('table-secondary', 'text-muted', 'opacity-75', 'table-warning', 'table-success');
                             if (newStatus === 'rejected') applicantRow.classList.add('table-secondary', 'text-muted', 'opacity-75');
                             else if (newStatus === 'shortlisted') applicantRow.classList.add('table-warning');
                             else if (newStatus === 'selected' || newStatus === 'hired') applicantRow.classList.add('table-success');
                             // Update Status Badge
                             const statusBadge = applicantRow.querySelector('.status-badge');
                             if (statusBadge) {
                                 statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                                 statusBadge.className = 'badge status-badge '; // Reset
                                 if (newStatus === 'pending') statusBadge.classList.add('text-bg-light', 'border');
                                 else if (newStatus === 'shortlisted') statusBadge.classList.add('text-bg-warning');
                                 else if (newStatus === 'rejected') statusBadge.classList.add('text-bg-secondary');
                                 else if (newStatus === 'selected') statusBadge.classList.add('text-bg-success');
                                 else if (newStatus === 'hired') statusBadge.classList.add('text-bg-primary');
                                 else statusBadge.classList.add('text-bg-secondary');
                             }
                             // Update Buttons (Add/Remove Reset, Toggle Active State)
                             const actionCell = applicantRow.querySelector('td:last-child'); // Assuming actions are last
                             if(actionCell){
                                 // --- Manage Reset Button ---
                                 const existingResetButton = actionCell.querySelector('button[data-status="pending"]');
                                 // Remove if status is now pending OR if it existed and status is no longer pending
                                 if (existingResetButton && newStatus === 'pending') {
                                      // Dispose tooltip before removing
                                      const tooltipInstance = bootstrap.Tooltip.getInstance(existingResetButton);
                                      if (tooltipInstance) tooltipInstance.dispose();
                                      existingResetButton.remove();
                                 }
                                 // Add if status is NOT pending AND it doesn't already exist
                                 else if (newStatus !== 'pending' && !existingResetButton) {
                                     const newResetButton = document.createElement('button');
                                     newResetButton.className = 'btn btn-sm status-btn btn-outline-info ms-1';
                                     newResetButton.dataset.applicantId = applicantId; newResetButton.dataset.jobId = jobId;
                                     newResetButton.dataset.status = 'pending'; newResetButton.dataset.bsToggle = 'tooltip';
                                     newResetButton.title = 'Reset Status';
                                     newResetButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16"><use xlink:href="#arrow-clockwise-icon"/></svg>';
                                     actionCell.appendChild(newResetButton);
                                     new bootstrap.Tooltip(newResetButton); // Initialize tooltip for new button
                                 }

                                 // --- Update Shortlist/Reject Button appearance ---
                                 actionCell.querySelectorAll('button[data-status="shortlisted"], button[data-status="rejected"]').forEach(btn => {
                                     const btnStatus = btn.dataset.status;
                                     // Reset classes
                                     btn.classList.remove('btn-warning', 'btn-secondary', 'btn-outline-warning', 'btn-outline-secondary');
                                     // Apply active class if it matches the new status
                                     if (btnStatus === newStatus) {
                                         if(btnStatus === 'shortlisted') btn.classList.add('btn-warning');
                                         else if(btnStatus === 'rejected') btn.classList.add('btn-secondary');
                                     } else { // Apply outline class otherwise
                                         if(btnStatus === 'shortlisted') btn.classList.add('btn-outline-warning');
                                         else if(btnStatus === 'rejected') btn.classList.add('btn-outline-secondary');
                                     }
                                 });
                             }
                        }
                    } else {
                         showCustomAlert(`Error updating status: ${data.error || 'Unknown error'}`, 'Error');
                    }
                })
                .catch(error => {
                     showCustomAlert(`Network or Server Error: ${error.error || error.message || 'Unknown error'}`, 'Error');
                 })
                .finally(() => { button.disabled = false; button.innerHTML = originalButtonHtml; });
            });
        } else { console.error("Table body 'tbody.table-group-divider' not found."); }
    }); // End DOMContentLoaded listener
   </script>
{% endblock %}